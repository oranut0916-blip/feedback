<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·åé¦ˆåˆ†æç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content.open {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }
        .upload-zone {
            border: 2px dashed #CBD5E1;
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3B82F6;
            background-color: #EFF6FF;
        }
        .category-panel {
            min-height: 200px;
            max-height: 450px;
            overflow-y: auto;
        }
        .feedback-item {
            font-size: 13px;
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
        }
        .feedback-item:active {
            cursor: grabbing;
        }
        .feedback-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        .feedback-item:last-child {
            border-bottom: none;
        }
        /* å·²æŸ¥çœ‹çŠ¶æ€ */
        .feedback-item.feedback-viewed {
            background-color: #f8fafc;
            border-left: 3px solid #94a3b8;
        }
        .feedback-item.feedback-viewed p {
            color: #64748b;
        }
        .stat-badge {
            font-size: 11px;
            padding: 2px 8px;
        }
        .category-column {
            transition: all 0.2s;
        }
        .category-column.drag-over {
            background-color: #DBEAFE;
            border: 2px dashed #3B82F6;
        }
        .custom-board {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .empty-drop-zone {
            min-height: 100px;
            border: 2px dashed #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            transition: all 0.2s;
        }
        .empty-drop-zone.drag-over {
            border-color: #3B82F6;
            background-color: #EFF6FF;
            color: #3B82F6;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .kanban-category-column.drag-over {
            background-color: #F3E8FF;
            border: 2px dashed #A855F7;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="max-w-full mx-auto px-4 py-2">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <h1 class="text-base font-bold text-gray-800">ç”¨æˆ·åé¦ˆåˆ†æ</h1>
                </div>
                <div class="flex items-center space-x-3">
                    {% if batches %}
                    <select id="batchSelect" onchange="switchBatch(this.value)" class="border border-gray-300 rounded px-2 py-1 text-sm">
                        {% for batch in batches %}
                        <option value="{{ batch.id }}" {% if current_batch and current_batch.id == batch.id %}selected{% endif %}>
                            {{ batch.filename }} ({{ batch.total_count }}æ¡)
                        </option>
                        {% endfor %}
                    </select>
                    {% if current_batch %}
                    <button onclick="exportData({{ current_batch.id }})" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                        ğŸ“¥ å¯¼å‡º
                    </button>
                    <button onclick="deleteBatch({{ current_batch.id }})" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                        ğŸ—‘ï¸ åˆ é™¤
                    </button>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-full mx-auto px-4 py-3">
        <!-- ä¸Šä¼ åŒºåŸŸ + ç»Ÿè®¡ä¿¡æ¯ æ¨ªå‘æ’åˆ— -->
        <div class="flex gap-4 mb-4">
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="bg-white rounded-lg shadow-sm p-4 w-64 flex-shrink-0">
                <h2 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“¤ ä¸Šä¼ CSV</h2>
                <div id="uploadZone" class="upload-zone rounded-lg p-4 text-center cursor-pointer"
                     onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
                    <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="text-xs text-gray-500">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ </p>
                </div>
                <div id="uploadStatus" class="mt-2 hidden">
                    <div class="flex items-center justify-center space-x-1">
                        <svg class="animate-spin h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-xs text-blue-500">åˆ†æä¸­...</span>
                    </div>
                </div>
            </div>

            {% if stats %}
            <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
            <div class="flex-1 bg-white rounded-lg shadow-sm p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold text-gray-700">ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆ <span class="text-xs text-gray-400">(å¯æ‹–æ‹½åé¦ˆåˆ°å…¶ä»–åˆ†ç±»)</span></h2>
                    <div class="flex gap-4 text-sm" id="statsOverview">
                        <span class="text-blue-600 font-medium">æ€»è®¡: <span id="totalCount">{{ stats.total }}</span></span>
                        {% for user_type, count in stats.user_distribution.items() %}
                        <span class="text-gray-600">{{ user_type }}: {{ count }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="flex flex-wrap gap-2" id="categoryStats">
                    {% for cat_stat in stats.category_stats %}
                    <div class="flex items-center bg-gray-50 rounded px-3 py-1.5 cursor-pointer hover:bg-blue-50" 
                         onclick="toggleCategory('{{ cat_stat.category }}')"
                         data-category="{{ cat_stat.category }}">
                        <span class="text-sm text-gray-700">{{ cat_stat.category }}</span>
                        <span class="ml-2 bg-blue-500 text-white rounded-full stat-badge category-count">{{ cat_stat.count }}</span>
                        <span class="ml-1 text-xs text-gray-400 category-percent">({{ (cat_stat.count / stats.total * 100)|round(1) }}%)</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        {% if grouped_feedbacks %}
        <!-- æ·»åŠ è‡ªå®šä¹‰çœ‹æ¿æŒ‰é’® -->
        <div class="mb-3 flex items-center gap-2">
            <button onclick="showAddBoardModal()" class="flex items-center space-x-1 bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-4 py-2 rounded-lg text-sm hover:from-purple-600 hover:to-indigo-600 transition shadow">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                <span>æ·»åŠ è‡ªå®šä¹‰çœ‹æ¿</span>
            </button>
            <span class="text-xs text-gray-500">ğŸ’¡ æç¤ºï¼šå¯ä»¥æ‹–æ‹½åé¦ˆæ¡ç›®åˆ°ä»»æ„åˆ†ç±»çœ‹æ¿ä¸­</span>
        </div>

        <!-- åˆ†ç±»è¯¦æƒ… - å¹¶åˆ—ç½‘æ ¼å¸ƒå±€ -->
        <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3" id="categoriesGrid">
            {% for category, feedbacks in grouped_feedbacks.items() %}
            <div class="bg-white rounded-lg shadow-sm overflow-hidden category-column" 
                 id="panel-{{ loop.index }}"
                 data-category="{{ category }}"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 ondrop="handleDrop(event, '{{ category }}')">
                <!-- åˆ†ç±»æ ‡é¢˜ -->
                <div class="bg-gray-50 px-3 py-2 border-b flex items-center justify-between group/header">
                    <div class="flex items-center cursor-pointer" onclick="togglePanel({{ loop.index }})">
                        <span class="font-medium text-sm text-gray-800 category-title">{{ category }}</span>
                        <span class="ml-2 bg-blue-500 text-white text-xs rounded-full px-2 py-0.5 panel-count">{{ feedbacks|length }}</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button onclick="event.stopPropagation(); showRenameModal('{{ category }}')" 
                                class="p-1 rounded hover:bg-gray-200 opacity-0 group-hover/header:opacity-100 transition-opacity"
                                title="é‡å‘½ååˆ†ç±»">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <svg class="panel-icon-{{ loop.index }} w-4 h-4 text-gray-400 transform transition-transform rotate-180 cursor-pointer" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24"
                             onclick="togglePanel({{ loop.index }})">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
                <!-- åˆ†ç±»å†…å®¹ - é»˜è®¤å±•å¼€ -->
                <div class="panel-content-{{ loop.index }} category-panel open" style="max-height: 400px;">
                    {% for feedback in feedbacks %}
                    <div class="feedback-item hover:bg-gray-50 group" 
                         data-feedback-id="{{ feedback.id }}"
                         data-category="{{ category }}"
                         draggable="true"
                         ondragstart="handleDragStart(event, {{ feedback.id }}, '{{ category }}')"
                         ondragend="handleDragEnd(event)">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="text-gray-700 leading-relaxed">{{ feedback.content }}</p>
                                {% if feedback.attachment %}
                                <div class="mt-1 text-xs text-blue-500 bg-blue-50 rounded p-2">
                                    <div class="flex items-center mb-1">
                                        <svg class="w-3 h-3 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                        </svg>
                                        <span class="text-blue-600 font-medium">é™„ä»¶:</span>
                                    </div>
                                    <div class="space-y-1 pl-4">
                                        {% for url in feedback.attachment.split('\n') %}
                                        {% if url.strip() %}
                                        <a href="{{ url.strip() }}" target="_blank" class="block hover:underline break-all text-blue-600">
                                            {{ url.strip() }}
                                        </a>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex items-center space-x-1 ml-2 flex-shrink-0">
                                <button onclick="showFeedbackDetail({{ feedback.id }})" 
                                        class="detail-btn opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-gray-100"
                                        title="æŸ¥çœ‹è¯¦æƒ…">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </button>
                                <button onclick="copyFeedback({{ feedback.id }}, '{{ feedback.content|e }}', this)" 
                                        class="copy-btn opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-blue-100"
                                        title="å¤åˆ¶å†…å®¹">
                                    <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                                <button onclick="toggleKanban({{ feedback.id }}, this)" 
                                        class="kanban-btn opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-purple-100"
                                        title="åŠ å…¥/ç§»å‡ºé‡ç‚¹çœ‹æ¿">
                                    <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                    </svg>
                                </button>
                                <span class="text-xs px-1.5 py-0.5 rounded
                                    {% if feedback.user_type == 'ä¼šå‘˜' %}
                                    bg-green-100 text-green-700
                                    {% else %}
                                    bg-gray-100 text-gray-600
                                    {% endif %}">
                                    {{ feedback.user_type }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- é‡ç‚¹çœ‹æ¿åŒºåŸŸ -->
        <div class="mt-6" id="keyFeedbackSection">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-purple-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                    </svg>
                    <h2 class="font-bold text-gray-800">é‡ç‚¹çœ‹æ¿</h2>
                    <span id="kanbanTotalCount" class="bg-purple-500 text-white text-xs rounded-full px-2 py-0.5">0</span>
                    <span class="text-xs text-gray-400">(å¯æ‹–æ‹½åé¦ˆåˆ°ä¸åŒåˆ†ç±»)</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="addKanbanCategory()" class="flex items-center space-x-1 px-3 py-1.5 bg-purple-500 text-white rounded text-sm hover:bg-purple-600 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>æ·»åŠ åˆ†ç±»</span>
                    </button>
                    <button onclick="toggleKeyFeedbackSection()" class="p-1 rounded hover:bg-gray-200" title="æŠ˜å /å±•å¼€">
                        <svg id="keyFeedbackToggleIcon" class="w-4 h-4 text-gray-500 transform rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- çœ‹æ¿å†…å®¹ - ç½‘æ ¼å¸ƒå±€ -->
            <div id="kanbanContent" class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3">
                <div class="bg-white rounded-lg shadow-sm p-8 text-center col-span-full">
                    <svg class="w-10 h-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                    </svg>
                    <p class="text-sm text-gray-400">æš‚æ— é‡ç‚¹åé¦ˆ</p>
                    <p class="text-xs text-gray-300 mt-1">ç‚¹å‡»åé¦ˆæ—çš„ä¹¦ç­¾å›¾æ ‡æ·»åŠ </p>
                </div>
            </div>
        </div>
        
        <!-- ç»“è®ºè¾“å…¥åŒºåŸŸ -->
        <div class="mt-6 bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="px-4 py-3 border-b bg-gray-50 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h2 class="font-bold text-gray-800">åˆ†æç»“è®º</h2>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="copyConclusion()" class="flex items-center space-x-1 px-3 py-1 bg-blue-100 text-blue-600 rounded text-xs hover:bg-blue-200 transition" title="å¤åˆ¶ç»“è®º">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        <span>å¤åˆ¶</span>
                    </button>
                    <button onclick="saveConclusion()" class="flex items-center space-x-1 px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600 transition">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>ä¿å­˜</span>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <textarea id="conclusionText" 
                          class="w-full h-40 p-3 border border-gray-200 rounded-lg resize-y focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                          placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„åˆ†æç»“è®º...&#10;&#10;ä¾‹å¦‚ï¼š&#10;1. ä¸»è¦é—®é¢˜é›†ä¸­åœ¨...&#10;2. ç”¨æˆ·æ™®éåæ˜ ...&#10;3. å»ºè®®æ”¹è¿›æ–¹å‘..."></textarea>
                <div class="mt-2 flex items-center justify-between text-xs text-gray-400">
                    <span id="conclusionSaveStatus"></span>
                    <span id="conclusionCharCount">0 å­—</span>
                </div>
            </div>
        </div>
        {% else %}
        <!-- ç©ºçŠ¶æ€ -->
        <div class="bg-white rounded-lg shadow-sm p-8 text-center">
            <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="text-base font-medium text-gray-700 mb-1">æš‚æ— æ•°æ®</h3>
            <p class="text-sm text-gray-500">è¯·ä¸Šä¼ CSVæ–‡ä»¶å¼€å§‹åˆ†æ</p>
        </div>
        {% endif %}
    </main>

    <!-- æ·»åŠ è‡ªå®šä¹‰çœ‹æ¿å¼¹çª— -->
    <div id="addBoardModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-96">
            <h3 class="text-lg font-bold text-gray-800 mb-4">æ·»åŠ è‡ªå®šä¹‰çœ‹æ¿</h3>
            <input type="text" id="newBoardName" placeholder="è¾“å…¥çœ‹æ¿åç§°" 
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <div class="flex justify-end space-x-2">
                <button onclick="hideAddBoardModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="addCustomBoard()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">åˆ›å»º</button>
            </div>
        </div>
    </div>


    <!-- é‡å‘½ååˆ†ç±»å¼¹çª— -->
    <div id="renameModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-96">
            <h3 class="text-lg font-bold text-gray-800 mb-4">é‡å‘½ååˆ†ç±»</h3>
            <input type="hidden" id="oldCategoryName">
            <div class="mb-3">
                <label class="block text-sm text-gray-600 mb-1">åŸåç§°</label>
                <div id="oldCategoryDisplay" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-700"></div>
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-600 mb-1">æ–°åç§°</label>
                <input type="text" id="newCategoryName" placeholder="è¾“å…¥æ–°çš„åˆ†ç±»åç§°" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="hideRenameModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="renameCategory()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">ç¡®è®¤ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- åé¦ˆè¯¦æƒ…å¼¹çª— -->
    <div id="feedbackDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-2xl max-h-[85vh] overflow-hidden">
            <div class="px-5 py-4 border-b bg-gray-50 flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-800">åé¦ˆè¯¦æƒ…</h3>
                <button onclick="hideFeedbackDetailModal()" class="p-1 rounded hover:bg-gray-200">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="feedbackDetailContent" class="p-5 overflow-y-auto" style="max-height: calc(85vh - 120px);">
                <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡ JavaScript å¡«å…… -->
                <div class="text-center py-8 text-gray-400">
                    <svg class="w-8 h-8 mx-auto mb-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    åŠ è½½ä¸­...
                </div>
            </div>
            <div class="px-5 py-3 border-t bg-gray-50 flex justify-end">
                <button onclick="hideFeedbackDetailModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¡† -->
    <div id="toast" class="fixed bottom-4 right-4 transform translate-y-full opacity-0 transition-all duration-300 z-50">
        <div class="bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg flex items-center space-x-2 text-sm">
            <svg id="toastIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        // å½“å‰æ‰¹æ¬¡ID
        const currentBatchId = {{ current_batch.id if current_batch else 'null' }};
        
        // æ‹–æ‹½ç›¸å…³å˜é‡
        let draggedItem = null;
        let draggedFeedbackId = null;
        let originalCategory = null;

        // ========== æ‹–æ‹½åŠŸèƒ½ ==========
        function handleDragStart(event, feedbackId, category) {
            draggedItem = event.target.closest('.feedback-item');
            draggedFeedbackId = feedbackId;
            originalCategory = category;
            draggedItem.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', feedbackId);
        }

        function handleDragEnd(event) {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            draggedItem = null;
            draggedFeedbackId = null;
            originalCategory = null;
            
            // ç§»é™¤æ‰€æœ‰æ‹–æ‹½æ ·å¼
            document.querySelectorAll('.category-column').forEach(col => {
                col.classList.remove('drag-over');
            });
            document.querySelectorAll('.empty-drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const column = event.target.closest('.category-column');
            if (column) {
                column.classList.add('drag-over');
            }
        }

        function handleDragLeave(event) {
            const column = event.target.closest('.category-column');
            if (column && !column.contains(event.relatedTarget)) {
                column.classList.remove('drag-over');
            }
        }

        async function handleDrop(event, targetCategory) {
            event.preventDefault();
            const column = event.target.closest('.category-column');
            if (column) {
                column.classList.remove('drag-over');
            }

            if (!draggedFeedbackId || originalCategory === targetCategory) {
                return;
            }

            // ä¿å­˜å¼•ç”¨ï¼Œå› ä¸º draggedItem ä¼šåœ¨ dragend æ—¶è¢«æ¸…ç©º
            const itemToMove = draggedItem;
            const feedbackId = draggedFeedbackId;
            const fromCategory = originalCategory;

            try {
                const response = await fetch(`/api/feedback/${feedbackId}/category`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category: targetCategory })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ç§»åŠ¨DOMå…ƒç´ 
                    const targetPanel = document.querySelector(`.category-column[data-category="${targetCategory}"] .category-panel`);
                    if (targetPanel && itemToMove) {
                        // ç§»é™¤ç©ºç™½æç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
                        const emptyZone = targetPanel.querySelector('.empty-drop-zone');
                        if (emptyZone) {
                            emptyZone.remove();
                        }
                        
                        itemToMove.dataset.category = targetCategory;
                        targetPanel.appendChild(itemToMove);
                        itemToMove.classList.remove('dragging');
                    }
                    
                    // æ›´æ–°ç»Ÿè®¡æ•°å­—
                    updateStats(result.stats);
                    updatePanelCounts();
                    showToast(`å·²ç§»åŠ¨åˆ°ã€Œ${targetCategory}ã€`, 'success');
                } else {
                    showToast(result.detail || 'ç§»åŠ¨å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç§»åŠ¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ›´æ–°æ‰€æœ‰é¢æ¿çš„è®¡æ•°
        function updatePanelCounts() {
            document.querySelectorAll('.category-column').forEach(panel => {
                const count = panel.querySelectorAll('.feedback-item').length;
                const countBadge = panel.querySelector('.panel-count');
                if (countBadge) {
                    countBadge.textContent = count;
                }
            });
        }

        // æ›´æ–°ç»Ÿè®¡æ•°å­—
        function updateStats(stats) {
            if (!stats) return;
            
            // æ›´æ–°æ€»æ•°
            const totalEl = document.getElementById('totalCount');
            if (totalEl && stats.total !== undefined) {
                totalEl.textContent = stats.total;
            }
            
            // æ›´æ–°å„åˆ†ç±»ç»Ÿè®¡
            const categoryStatsEl = document.getElementById('categoryStats');
            if (categoryStatsEl && stats.category_stats) {
                // å…ˆæ¸…é™¤æ‰€æœ‰ç°æœ‰ç»Ÿè®¡ï¼ˆé™¤äº†è‡ªå®šä¹‰çœ‹æ¿ï¼‰
                // ç„¶åæ ¹æ®æ–°æ•°æ®æ›´æ–°
                stats.category_stats.forEach(cat => {
                    // æŸ¥æ‰¾æˆ–åˆ›å»ºç»Ÿè®¡æ ‡ç­¾
                    let statEl = categoryStatsEl.querySelector(`[data-category="${cat.category}"]`);
                    
                    if (statEl) {
                        // æ›´æ–°å·²æœ‰çš„ç»Ÿè®¡
                        const countEl = statEl.querySelector('.category-count');
                        const percentEl = statEl.querySelector('.category-percent');
                        if (countEl) countEl.textContent = cat.count;
                        if (percentEl) percentEl.textContent = `(${(cat.count / stats.total * 100).toFixed(1)}%)`;
                    } else {
                        // å¦‚æœæ˜¯æ–°åˆ†ç±»ï¼Œæ·»åŠ ç»Ÿè®¡æ ‡ç­¾
                        const newStatEl = document.createElement('div');
                        newStatEl.className = 'flex items-center bg-gray-50 rounded px-3 py-1.5 cursor-pointer hover:bg-blue-50';
                        newStatEl.dataset.category = cat.category;
                        newStatEl.onclick = () => toggleCategory(cat.category);
                        newStatEl.innerHTML = `
                            <span class="text-sm text-gray-700">${cat.category}</span>
                            <span class="ml-2 bg-blue-500 text-white rounded-full stat-badge category-count">${cat.count}</span>
                            <span class="ml-1 text-xs text-gray-400 category-percent">(${(cat.count / stats.total * 100).toFixed(1)}%)</span>
                        `;
                        categoryStatsEl.appendChild(newStatEl);
                    }
                });
            }
        }

        // ========== è‡ªå®šä¹‰çœ‹æ¿åŠŸèƒ½ ==========
        function showAddBoardModal() {
            document.getElementById('addBoardModal').classList.remove('hidden');
            document.getElementById('addBoardModal').classList.add('flex');
            document.getElementById('newBoardName').focus();
        }

        function hideAddBoardModal() {
            document.getElementById('addBoardModal').classList.add('hidden');
            document.getElementById('addBoardModal').classList.remove('flex');
            document.getElementById('newBoardName').value = '';
        }

        function addCustomBoard() {
            const name = document.getElementById('newBoardName').value.trim();
            if (!name) {
                showToast('è¯·è¾“å…¥çœ‹æ¿åç§°', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåçœ‹æ¿
            if (document.querySelector(`[data-category="${name}"]`)) {
                showToast('è¯¥çœ‹æ¿å·²å­˜åœ¨', 'error');
                return;
            }

            // åˆ›å»ºæ–°çœ‹æ¿DOM
            const grid = document.getElementById('categoriesGrid');
            const panelIndex = grid.children.length + 1;
            
            const newPanel = document.createElement('div');
            newPanel.className = 'bg-white rounded-lg shadow-sm overflow-hidden category-column';
            newPanel.id = `panel-${panelIndex}`;
            newPanel.dataset.category = name;
            newPanel.ondragover = handleDragOver;
            newPanel.ondragleave = handleDragLeave;
            newPanel.ondrop = (e) => handleDrop(e, name);
            
            newPanel.innerHTML = `
                <div class="custom-board px-3 py-2 border-b flex items-center justify-between cursor-pointer" onclick="togglePanel(${panelIndex})">
                    <div class="flex items-center">
                        <span class="font-medium text-sm text-white category-title">${name}</span>
                        <span class="ml-2 bg-white/20 text-white text-xs rounded-full px-2 py-0.5 panel-count">0</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button onclick="event.stopPropagation(); deleteCustomBoard('${name}')" class="p-1 rounded hover:bg-white/20" title="åˆ é™¤çœ‹æ¿">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                        <svg class="panel-icon-${panelIndex} w-4 h-4 text-white transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
                <div class="panel-content-${panelIndex} category-panel open" style="max-height: 400px;">
                    <div class="empty-drop-zone m-2 rounded-lg p-4">
                        <span>æ‹–æ‹½åé¦ˆåˆ°è¿™é‡Œ</span>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°ç½‘æ ¼æœ€å‰é¢
            grid.insertBefore(newPanel, grid.firstChild);
            
            // æ›´æ–°ç»Ÿè®¡åŒºåŸŸ
            addCategoryStat(name);
            
            hideAddBoardModal();
            showToast(`å·²åˆ›å»ºçœ‹æ¿ã€Œ${name}ã€`, 'success');
        }

        function addCategoryStat(categoryName) {
            const statsContainer = document.getElementById('categoryStats');
            if (!statsContainer) return;
            
            const statEl = document.createElement('div');
            statEl.className = 'flex items-center bg-purple-50 rounded px-3 py-1.5 cursor-pointer hover:bg-purple-100';
            statEl.dataset.category = categoryName;
            statEl.onclick = () => toggleCategory(categoryName);
            statEl.innerHTML = `
                <span class="text-sm text-purple-700">${categoryName}</span>
                <span class="ml-2 bg-purple-500 text-white rounded-full stat-badge category-count">0</span>
                <span class="ml-1 text-xs text-purple-400 category-percent">(0%)</span>
            `;
            statsContainer.insertBefore(statEl, statsContainer.firstChild);
        }

        function deleteCustomBoard(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤çœ‹æ¿ã€Œ${name}ã€å—ï¼Ÿ\nçœ‹æ¿ä¸­çš„åé¦ˆå°†ç§»å›"å…¶ä»–"åˆ†ç±»ã€‚`)) {
                return;
            }
            
            const panel = document.querySelector(`[data-category="${name}"]`);
            if (panel) {
                // ç§»åŠ¨åé¦ˆåˆ°"å…¶ä»–"åˆ†ç±»
                const feedbacks = panel.querySelectorAll('.feedback-item');
                feedbacks.forEach(async (fb) => {
                    const feedbackId = fb.dataset.feedbackId;
                    try {
                        await fetch(`/api/feedback/${feedbackId}/category`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ category: 'å…¶ä»–' })
                        });
                    } catch (e) {}
                });
                
                panel.remove();
            }
            
            // ç§»é™¤ç»Ÿè®¡
            const statEl = document.querySelector(`#categoryStats [data-category="${name}"]`);
            if (statEl) {
                statEl.remove();
            }
            
            showToast(`å·²åˆ é™¤çœ‹æ¿ã€Œ${name}ã€`, 'success');
        }

        // ========== æ–‡ä»¶ä¸Šä¼  ==========
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const uploadStatus = document.getElementById('uploadStatus');

        if (uploadZone) {
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
        }

        function handleFileSelect(event) {
            if (event.target.files[0]) {
                handleFile(event.target.files[0]);
            }
        }

        async function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showToast('è¯·ä¸Šä¼ CSVæ–‡ä»¶', 'error');
                return;
            }
            uploadStatus.classList.remove('hidden');
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const result = await response.json();
                if (response.ok && result.success) {
                    showToast(result.message, 'success');
                    setTimeout(() => window.location.href = '/batch/' + result.batch_id, 800);
                } else {
                    showToast(result.detail || 'ä¸Šä¼ å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ä¸Šä¼ å‡ºé”™: ' + error.message, 'error');
            } finally {
                uploadStatus.classList.add('hidden');
                fileInput.value = '';
            }
        }

        // ========== åŸºç¡€åŠŸèƒ½ ==========
        function switchBatch(batchId) {
            window.location.href = '/batch/' + batchId;
        }

        async function deleteBatch(batchId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) return;
            try {
                const response = await fetch('/batch/' + batchId, { method: 'DELETE' });
                if (response.ok) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    setTimeout(() => window.location.href = '/', 800);
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        function exportData(batchId) {
            window.location.href = '/export/' + batchId;
        }

        function togglePanel(index) {
            const content = document.querySelector('.panel-content-' + index);
            const icon = document.querySelector('.panel-icon-' + index);
            
            if (content.style.maxHeight === '0px') {
                content.style.maxHeight = '400px';
                icon.classList.add('rotate-180');
            } else {
                content.style.maxHeight = '0px';
                icon.classList.remove('rotate-180');
            }
        }

        function toggleCategory(category) {
            const panels = document.querySelectorAll('.category-column');
            panels.forEach(panel => {
                if (panel.dataset.category === category) {
                    panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    panel.classList.add('ring-2', 'ring-blue-400');
                    setTimeout(() => panel.classList.remove('ring-2', 'ring-blue-400'), 2000);
                }
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toastMessage.textContent = message;
            if (type === 'error') {
                toastIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
                toast.querySelector('div').className = 'bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center space-x-2 text-sm';
            } else {
                toastIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
                toast.querySelector('div').className = 'bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg flex items-center space-x-2 text-sm';
            }
            toast.classList.remove('translate-y-full', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-full', 'opacity-0'), 3000);
        }

        // ========== åé¦ˆè¯¦æƒ…åŠŸèƒ½ ==========
        
        async function showFeedbackDetail(feedbackId) {
            const modal = document.getElementById('feedbackDetailModal');
            const content = document.getElementById('feedbackDetailContent');
            
            // æ˜¾ç¤ºå¼¹çª—å’ŒåŠ è½½çŠ¶æ€
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            content.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <svg class="w-8 h-8 mx-auto mb-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    åŠ è½½ä¸­...
                </div>
            `;
            
            // æ ‡è®°ä¸ºå·²æŸ¥çœ‹
            markFeedbackAsViewed(feedbackId);
            
            try {
                const res = await fetch(`/api/feedback/${feedbackId}/detail`);
                const data = await res.json();
                
                if (data.success) {
                    renderFeedbackDetail(data);
                } else {
                    content.innerHTML = `<div class="text-center py-8 text-red-500">åŠ è½½å¤±è´¥: ${data.detail || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="text-center py-8 text-red-500">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function renderFeedbackDetail(data) {
            const content = document.getElementById('feedbackDetailContent');
            
            let html = `
                <div class="space-y-4">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-medium text-blue-800 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            åé¦ˆå†…å®¹
                        </h4>
                        <p class="text-gray-700">${escapeHtml(data.content)}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <span class="text-xs text-gray-500">ç”¨æˆ·ç±»å‹</span>
                            <p class="font-medium">${escapeHtml(data.user_type || 'æœªçŸ¥')}</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <span class="text-xs text-gray-500">æ™ºèƒ½åˆ†ç±»</span>
                            <p class="font-medium">${escapeHtml(data.category || 'æœªåˆ†ç±»')}</p>
                        </div>
                    </div>
            `;
            
            // é™„ä»¶
            if (data.attachment) {
                html += `
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-medium text-blue-800 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                            </svg>
                            é™„ä»¶
                        </h4>
                        <div class="space-y-1">
                            ${data.attachment.split('\n').filter(url => url.trim()).map(url => `
                                <a href="${escapeHtml(url.trim())}" target="_blank" class="block text-blue-600 hover:underline break-all text-sm">
                                    ${escapeHtml(url.trim())}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // æ‰€æœ‰å­—æ®µ
            if (data.fields && data.fields.length > 0) {
                html += `
                    <div class="border-t pt-4 mt-4">
                        <h4 class="font-medium text-gray-700 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                            </svg>
                            åŸå§‹æ•°æ®ï¼ˆå…¨éƒ¨å­—æ®µï¼‰
                        </h4>
                        <div class="bg-gray-50 rounded-lg overflow-hidden">
                            <table class="w-full text-sm">
                                <tbody>
                                    ${data.fields.map((field, index) => `
                                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                            <td class="px-3 py-2 font-medium text-gray-600 w-1/3 border-r">${escapeHtml(field.name)}</td>
                                            <td class="px-3 py-2 text-gray-700 break-all">${formatFieldValue(field.value)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        function formatFieldValue(value) {
            if (!value || value === '') return '<span class="text-gray-400">-</span>';
            
            const escaped = escapeHtml(String(value));
            
            // æ£€æµ‹æ˜¯å¦ä¸ºURL
            if (escaped.startsWith('http://') || escaped.startsWith('https://')) {
                return `<a href="${escaped}" target="_blank" class="text-blue-600 hover:underline break-all">${escaped}</a>`;
            }
            
            // å¤„ç†å¤šè¡Œå†…å®¹
            if (escaped.includes('\n')) {
                return escaped.split('\n').map(line => {
                    if (line.startsWith('http://') || line.startsWith('https://')) {
                        return `<a href="${line}" target="_blank" class="text-blue-600 hover:underline break-all">${line}</a>`;
                    }
                    return line;
                }).join('<br>');
            }
            
            return escaped;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function hideFeedbackDetailModal() {
            const modal = document.getElementById('feedbackDetailModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('feedbackDetailModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                hideFeedbackDetailModal();
            }
        });

        // ========== å¤åˆ¶å’Œå·²æŸ¥çœ‹åŠŸèƒ½ ==========
        
        // è·å–å·²æŸ¥çœ‹çš„åé¦ˆIDåˆ—è¡¨
        function getViewedFeedbacks() {
            const key = `viewed_feedbacks_${currentBatchId}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : [];
        }
        
        // ä¿å­˜å·²æŸ¥çœ‹çš„åé¦ˆID
        function saveViewedFeedback(feedbackId) {
            const key = `viewed_feedbacks_${currentBatchId}`;
            const viewed = getViewedFeedbacks();
            if (!viewed.includes(feedbackId)) {
                viewed.push(feedbackId);
                localStorage.setItem(key, JSON.stringify(viewed));
            }
        }
        
        // æ ‡è®°åé¦ˆä¸ºå·²æŸ¥çœ‹
        function markFeedbackAsViewed(feedbackId) {
            saveViewedFeedback(feedbackId);
            // æ›´æ–°æ‰€æœ‰è¯¥åé¦ˆçš„DOMå…ƒç´ æ ·å¼
            document.querySelectorAll(`[data-feedback-id="${feedbackId}"], [data-kanban-item="${feedbackId}"]`).forEach(el => {
                el.classList.add('feedback-viewed');
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶æ¢å¤å·²æŸ¥çœ‹çŠ¶æ€
        function restoreViewedState() {
            const viewed = getViewedFeedbacks();
            viewed.forEach(id => {
                document.querySelectorAll(`[data-feedback-id="${id}"], [data-kanban-item="${id}"]`).forEach(el => {
                    el.classList.add('feedback-viewed');
                });
            });
        }
        
        // å¤åˆ¶åé¦ˆå†…å®¹
        function copyFeedback(feedbackId, content, button) {
            // è§£ç HTMLå®ä½“
            const textarea = document.createElement('textarea');
            textarea.innerHTML = content;
            const decodedContent = textarea.value;
            
            navigator.clipboard.writeText(decodedContent).then(() => {
                // æ ‡è®°ä¸ºå·²æŸ¥çœ‹
                markFeedbackAsViewed(feedbackId);
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                const originalSvg = button.innerHTML;
                button.innerHTML = `<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>`;
                button.classList.add('opacity-100');
                
                setTimeout(() => {
                    button.innerHTML = originalSvg;
                    button.classList.remove('opacity-100');
                }, 1500);
                
                showToast('å·²å¤åˆ¶', 'success');
            }).catch(err => {
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            });
        }
        
        // å¤åˆ¶çœ‹æ¿ä¸­çš„åé¦ˆå†…å®¹
        function copyKanbanFeedback(feedbackId, button) {
            // ä»DOMä¸­è·å–å†…å®¹
            const itemEl = button.closest('.feedback-item');
            const contentEl = itemEl.querySelector('p');
            const content = contentEl ? contentEl.textContent : '';
            
            navigator.clipboard.writeText(content).then(() => {
                // æ ‡è®°ä¸ºå·²æŸ¥çœ‹
                markFeedbackAsViewed(feedbackId);
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                const originalSvg = button.innerHTML;
                button.innerHTML = `<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>`;
                button.classList.add('opacity-100');
                
                setTimeout(() => {
                    button.innerHTML = originalSvg;
                    button.classList.remove('opacity-100');
                }, 1500);
                
                showToast('å·²å¤åˆ¶', 'success');
            }).catch(err => {
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            });
        }

        // ========== ç»“è®ºåŠŸèƒ½ ==========
        
        // è·å–ç»“è®ºå­˜å‚¨key
        function getConclusionKey() {
            return `conclusion_${currentBatchId}`;
        }
        
        // åŠ è½½ç»“è®º
        function loadConclusion() {
            if (!currentBatchId) return;
            const key = getConclusionKey();
            const saved = localStorage.getItem(key);
            const textarea = document.getElementById('conclusionText');
            if (textarea && saved) {
                textarea.value = saved;
                updateCharCount();
            }
        }
        
        // ä¿å­˜ç»“è®º
        function saveConclusion() {
            if (!currentBatchId) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'error');
                return;
            }
            const textarea = document.getElementById('conclusionText');
            const key = getConclusionKey();
            localStorage.setItem(key, textarea.value);
            
            const status = document.getElementById('conclusionSaveStatus');
            status.textContent = 'å·²ä¿å­˜ ' + new Date().toLocaleTimeString();
            status.classList.add('text-green-500');
            setTimeout(() => {
                status.classList.remove('text-green-500');
            }, 2000);
            
            showToast('ç»“è®ºå·²ä¿å­˜', 'success');
        }
        
        // å¤åˆ¶ç»“è®º
        function copyConclusion() {
            const textarea = document.getElementById('conclusionText');
            if (!textarea.value.trim()) {
                showToast('ç»“è®ºä¸ºç©º', 'error');
                return;
            }
            navigator.clipboard.writeText(textarea.value).then(() => {
                showToast('ç»“è®ºå·²å¤åˆ¶', 'success');
            }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            });
        }
        
        // æ›´æ–°å­—æ•°ç»Ÿè®¡
        function updateCharCount() {
            const textarea = document.getElementById('conclusionText');
            const countEl = document.getElementById('conclusionCharCount');
            if (textarea && countEl) {
                countEl.textContent = textarea.value.length + ' å­—';
            }
        }
        
        // è‡ªåŠ¨ä¿å­˜ç»“è®ºï¼ˆå»¶è¿Ÿä¿å­˜ï¼‰
        let conclusionSaveTimeout = null;
        function autoSaveConclusion() {
            if (conclusionSaveTimeout) {
                clearTimeout(conclusionSaveTimeout);
            }
            conclusionSaveTimeout = setTimeout(() => {
                if (currentBatchId) {
                    const textarea = document.getElementById('conclusionText');
                    const key = getConclusionKey();
                    localStorage.setItem(key, textarea.value);
                    
                    const status = document.getElementById('conclusionSaveStatus');
                    status.textContent = 'è‡ªåŠ¨ä¿å­˜äº ' + new Date().toLocaleTimeString();
                }
            }, 2000);
        }

        // ========== é‡ç‚¹çœ‹æ¿åŠŸèƒ½ ==========
        let keyFeedbackExpanded = true;
        
        function toggleKeyFeedbackSection() {
            const content = document.getElementById('kanbanContent');
            const tabs = document.getElementById('kanbanCategoryTabs');
            const icon = document.getElementById('keyFeedbackToggleIcon');
            
            keyFeedbackExpanded = !keyFeedbackExpanded;
            
            if (keyFeedbackExpanded) {
                content.style.display = 'block';
                tabs.style.display = 'flex';
                icon.classList.add('rotate-180');
            } else {
                content.style.display = 'none';
                tabs.style.display = 'none';
                icon.classList.remove('rotate-180');
            }
        }
        
        async function loadKanbanData() {
            if (!currentBatchId) return;
            
            try {
                const res = await fetch(`/api/kanban/all?batch_id=${currentBatchId}`);
                const data = await res.json();
                
                if (data.success) {
                    renderKanbanPanel(data.kanban_data, data.categories);
                }
            } catch (error) {
                console.error('åŠ è½½çœ‹æ¿æ•°æ®å¤±è´¥:', error);
            }
        }
        
        function renderKanbanPanel(kanbanData, categories) {
            const content = document.getElementById('kanbanContent');
            
            // ç»Ÿè®¡æ€»æ•°
            let totalItems = 0;
            for (const categoryData of Object.values(kanbanData)) {
                if (categoryData.feedback_list) {
                    totalItems += categoryData.feedback_list.length;
                }
            }
            
            // æ›´æ–°è®¡æ•°
            document.getElementById('kanbanTotalCount').textContent = totalItems;
            
            // å¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (totalItems === 0 && categories.length === 0) {
                content.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-8 text-center col-span-full">
                        <svg class="w-10 h-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                        </svg>
                        <p class="text-sm text-gray-400">æš‚æ— é‡ç‚¹åé¦ˆ</p>
                        <p class="text-xs text-gray-300 mt-1">ç‚¹å‡»åé¦ˆæ—çš„ä¹¦ç­¾å›¾æ ‡æ·»åŠ </p>
                    </div>
                `;
                return;
            }
            
            // æ¸²æŸ“çœ‹æ¿ - å’Œæ™ºèƒ½åˆ†ç±»ä¸€æ ·çš„ç½‘æ ¼å¸ƒå±€
            let html = '';
            
            // å…ˆæ¸²æŸ“æœªåˆ†ç±»
            if (kanbanData['æœªåˆ†ç±»'] && kanbanData['æœªåˆ†ç±»'].feedback_list.length > 0) {
                html += renderKanbanCategory('æœªåˆ†ç±»', kanbanData['æœªåˆ†ç±»'], null);
            }
            
            // å†æ¸²æŸ“å„ä¸ªåˆ†ç±»
            for (const cat of categories) {
                const catData = kanbanData[cat.name] || { feedback_list: [], color: cat.color, category_id: cat.id };
                html += renderKanbanCategory(cat.name, catData, cat.id);
            }
            
            // å¦‚æœæœ‰æœªåˆ†ç±»ä½†æ²¡æœ‰åˆ†ç±»ï¼Œæˆ–æœ‰åˆ†ç±»ä½†æ²¡å†…å®¹ï¼Œä¹Ÿè¦æ˜¾ç¤º
            if (html === '') {
                html = `
                    <div class="bg-white rounded-lg shadow-sm p-8 text-center col-span-full">
                        <svg class="w-10 h-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                        </svg>
                        <p class="text-sm text-gray-400">æš‚æ— é‡ç‚¹åé¦ˆ</p>
                        <p class="text-xs text-gray-300 mt-1">ç‚¹å‡»åé¦ˆæ—çš„ä¹¦ç­¾å›¾æ ‡æ·»åŠ </p>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }
        
        function renderKanbanCategory(name, categoryData, categoryId) {
            const items = categoryData.feedback_list || [];
            const color = categoryData.color || '#6B7280';
            const panelId = categoryId || 'uncategorized';
            
            return `
                <div class="bg-white rounded-lg shadow-sm overflow-hidden kanban-category-column" 
                     data-kanban-category="${panelId}"
                     ondragover="handleKanbanDragOver(event)"
                     ondragleave="handleKanbanDragLeave(event)"
                     data-target-category-id="${categoryId !== null ? categoryId : ''}"
                     ondrop="handleKanbanDropEvent(event)">
                    <!-- åˆ†ç±»æ ‡é¢˜ -->
                    <div class="px-3 py-2 border-b flex items-center justify-between" style="background-color: ${color}10;">
                        <div class="flex items-center">
                            <span class="font-medium text-sm" style="color: ${color};">${name}</span>
                            <span class="ml-2 text-white text-xs rounded-full px-2 py-0.5" style="background-color: ${color};">${items.length}</span>
                        </div>
                        ${categoryId ? `
                        <button onclick="deleteKanbanCategory(${categoryId}, '${name}')" class="p-1 rounded hover:bg-gray-200 opacity-50 hover:opacity-100" title="åˆ é™¤åˆ†ç±»">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                        ` : ''}
                    </div>
                    <!-- åˆ†ç±»å†…å®¹ -->
                    <div class="category-panel" style="max-height: 400px; min-height: 100px;">
                        ${items.length === 0 ? `
                            <div class="p-4 text-center text-gray-300 text-sm">
                                æ‹–æ‹½åé¦ˆåˆ°è¿™é‡Œ
                            </div>
                        ` : items.map(item => `
                            <div class="feedback-item hover:bg-gray-50 group border-b last:border-b-0 ${getViewedFeedbacks().includes(item.feedback_id) ? 'feedback-viewed' : ''}"
                                 data-kanban-item="${item.feedback_id}"
                                 data-kanban-category-id="${categoryId || ''}"
                                 draggable="true"
                                 ondragstart="handleKanbanItemDragStart(event, ${item.feedback_id}, '${categoryId !== null ? categoryId : ''}')"
                                 ondragend="handleKanbanItemDragEnd(event)">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <p class="text-gray-700 leading-relaxed text-sm">${item.content}</p>
                                        ${item.attachment ? `
                                        <div class="mt-1 text-xs text-blue-500 bg-blue-50 rounded p-2">
                                            <div class="flex items-center mb-1">
                                                <svg class="w-3 h-3 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                                </svg>
                                                <span class="text-blue-600 font-medium">é™„ä»¶:</span>
                                            </div>
                                            <div class="space-y-1 pl-4">
                                                ${item.attachment.split('\\n').filter(url => url.trim()).map(url => `
                                                    <a href="${url.trim()}" target="_blank" class="block hover:underline break-all text-blue-600">
                                                        ${url.trim()}
                                                    </a>
                                                `).join('')}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                    <div class="flex items-center space-x-1 ml-2 flex-shrink-0">
                                        <button onclick="showFeedbackDetail(${item.feedback_id})" 
                                                class="detail-btn opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-gray-100"
                                                title="æŸ¥çœ‹è¯¦æƒ…">
                                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </button>
                                        <button onclick="copyKanbanFeedback(${item.feedback_id}, this)" 
                                                class="copy-btn opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-blue-100"
                                                title="å¤åˆ¶å†…å®¹">
                                            <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                        <button onclick="removeFromKanbanPanel(${item.feedback_id})" 
                                                class="p-1 rounded hover:bg-red-100 opacity-0 group-hover:opacity-100 transition-opacity"
                                                title="ä»çœ‹æ¿ç§»é™¤">
                                            <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                        <span class="text-xs px-1.5 py-0.5 rounded ${item.user_type === 'ä¼šå‘˜' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
                                            ${item.user_type || 'æœªçŸ¥'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        async function removeFromKanbanPanel(feedbackId) {
            try {
                const res = await fetch('/api/kanban/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback_id: feedbackId })
                });
                const data = await res.json();
                
                if (data.success) {
                    // é‡æ–°åŠ è½½çœ‹æ¿æ•°æ®
                    loadKanbanData();
                    
                    // æ›´æ–°ä¸»é¡µé¢çš„æŒ‰é’®çŠ¶æ€
                    const mainBtn = document.querySelector(`[data-feedback-id="${feedbackId}"] .kanban-btn`);
                    if (mainBtn) {
                        updateKanbanButton(mainBtn, false);
                    }
                    
                    showToast('å·²ä»çœ‹æ¿ç§»é™¤', 'success');
                }
            } catch (error) {
                showToast('ç§»é™¤å¤±è´¥', 'error');
            }
        }
        
        async function addKanbanCategory() {
            if (!currentBatchId) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'error');
                return;
            }
            
            const name = prompt('è¯·è¾“å…¥åˆ†ç±»åç§°:');
            if (!name || !name.trim()) return;
            
            try {
                const res = await fetch('/api/kanban/category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ batch_id: currentBatchId, name: name.trim() })
                });
                const data = await res.json();
                
                if (data.success) {
                    loadKanbanData();
                    showToast('åˆ†ç±»å·²åˆ›å»º', 'success');
                } else {
                    showToast(data.detail || 'åˆ›å»ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ›å»ºå¤±è´¥', 'error');
            }
        }
        
        async function deleteKanbanCategory(categoryId, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±»ã€Œ${name}ã€å—ï¼Ÿ\nè¯¥åˆ†ç±»ä¸‹çš„åé¦ˆå°†ç§»åˆ°æœªåˆ†ç±»ã€‚`)) {
                return;
            }
            
            try {
                const res = await fetch(`/api/kanban/categories/${categoryId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    loadKanbanData();
                    showToast('åˆ†ç±»å·²åˆ é™¤', 'success');
                } else {
                    showToast(data.detail || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        // çœ‹æ¿å†…æ‹–æ‹½ç›¸å…³
        let kanbanDraggedItem = null;
        let kanbanDraggedFeedbackId = null;
        let kanbanOriginalCategoryId = null;
        
        function handleKanbanItemDragStart(event, feedbackId, categoryIdStr) {
            kanbanDraggedItem = event.target.closest('.feedback-item');
            kanbanDraggedFeedbackId = feedbackId;
            kanbanOriginalCategoryId = categoryIdStr === '' ? null : parseInt(categoryIdStr);
            kanbanDraggedItem.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleKanbanItemDragEnd(event) {
            if (kanbanDraggedItem) {
                kanbanDraggedItem.classList.remove('dragging');
            }
            kanbanDraggedItem = null;
            kanbanDraggedFeedbackId = null;
            kanbanOriginalCategoryId = null;
            
            document.querySelectorAll('.kanban-category-column').forEach(col => {
                col.classList.remove('drag-over');
            });
        }
        
        function handleKanbanDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const column = event.target.closest('.kanban-category-column');
            if (column) {
                column.classList.add('drag-over');
            }
        }
        
        function handleKanbanDragLeave(event) {
            const column = event.target.closest('.kanban-category-column');
            if (column && !column.contains(event.relatedTarget)) {
                column.classList.remove('drag-over');
            }
        }
        
        function handleKanbanDropEvent(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const column = event.target.closest('.kanban-category-column');
            if (column) {
                column.classList.remove('drag-over');
                
                // åœ¨dragendæ¸…ç©ºå˜é‡ä¹‹å‰ï¼Œå…ˆä¿å­˜æ‹–æ‹½æ•°æ®
                const feedbackId = kanbanDraggedFeedbackId;
                const originalCatId = kanbanOriginalCategoryId;
                
                const targetCategoryIdStr = column.dataset.targetCategoryId;
                const targetCategoryId = targetCategoryIdStr === '' ? null : parseInt(targetCategoryIdStr);
                
                // ä½¿ç”¨ä¿å­˜çš„æ•°æ®è¿›è¡Œç§»åŠ¨
                if (feedbackId && originalCatId !== targetCategoryId) {
                    handleKanbanDrop(feedbackId, originalCatId, targetCategoryId);
                }
            }
        }
        
        async function handleKanbanDrop(feedbackId, originalCategoryId, targetCategoryId) {
            if (!feedbackId) {
                return;
            }
            
            // æ¯”è¾ƒæ˜¯å¦ç›¸åŒåˆ†ç±»ï¼ˆå¤„ç†nullå’Œundefinedæƒ…å†µï¼‰
            const isSameCategory = (originalCategoryId === targetCategoryId) || 
                                   (originalCategoryId == null && targetCategoryId == null);
            if (isSameCategory) {
                return;
            }
            
            try {
                const res = await fetch('/api/kanban/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        feedback_id: feedbackId, 
                        category_id: targetCategoryId 
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    loadKanbanData();
                    showToast('å·²ç§»åŠ¨åˆ°æ–°åˆ†ç±»', 'success');
                } else {
                    showToast(data.detail || 'ç§»åŠ¨å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç§»åŠ¨å¤±è´¥:', error);
                showToast('ç§»åŠ¨å¤±è´¥', 'error');
            }
        }
        
        async function toggleKanban(feedbackId, btn) {
            try {
                const checkRes = await fetch(`/api/kanban/check/${feedbackId}`);
                const checkData = await checkRes.json();
                
                if (checkData.in_kanban) {
                    const res = await fetch('/api/kanban/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ feedback_id: feedbackId })
                    });
                    const data = await res.json();
                    if (data.success) {
                        updateKanbanButton(btn, false);
                        loadKanbanData();
                        showToast('å·²ä»çœ‹æ¿ç§»é™¤', 'success');
                    }
                } else {
                    const res = await fetch('/api/kanban/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ feedback_id: feedbackId })
                    });
                    const data = await res.json();
                    if (data.success) {
                        updateKanbanButton(btn, true);
                        loadKanbanData();
                        markFeedbackAsViewed(feedbackId); // æ ‡è®°ä¸ºå·²æŸ¥çœ‹
                        showToast('å·²åŠ å…¥é‡ç‚¹çœ‹æ¿', 'success');
                    }
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function updateKanbanButton(btn, inKanban) {
            const svg = btn.querySelector('svg');
            if (inKanban) {
                svg.setAttribute('fill', 'currentColor');
                btn.classList.add('opacity-100');
                btn.classList.remove('opacity-0');
            } else {
                svg.setAttribute('fill', 'none');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çœ‹æ¿çŠ¶æ€å¹¶åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', async function() {
            // åŠ è½½é‡ç‚¹çœ‹æ¿æ•°æ®
            loadKanbanData();
            
            // æ¢å¤å·²æŸ¥çœ‹çŠ¶æ€
            restoreViewedState();
            
            // åŠ è½½ç»“è®º
            loadConclusion();
            
            // ç»“è®ºè¾“å…¥æ¡†äº‹ä»¶ç»‘å®š
            const conclusionText = document.getElementById('conclusionText');
            if (conclusionText) {
                conclusionText.addEventListener('input', function() {
                    updateCharCount();
                    autoSaveConclusion();
                });
            }
            
            // æ£€æŸ¥åé¦ˆçš„çœ‹æ¿çŠ¶æ€
            const feedbackItems = document.querySelectorAll('[data-feedback-id]');
            for (const item of feedbackItems) {
                const feedbackId = item.dataset.feedbackId;
                try {
                    const res = await fetch(`/api/kanban/check/${feedbackId}`);
                    const data = await res.json();
                    if (data.in_kanban) {
                        const btn = item.querySelector('.kanban-btn');
                        if (btn) {
                            updateKanbanButton(btn, true);
                        }
                    }
                } catch (e) {}
            }
        });

        // å›è½¦é”®åˆ›å»ºçœ‹æ¿
        document.getElementById('newBoardName')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addCustomBoard();
            }
        });

        // ========== é‡å‘½ååˆ†ç±»åŠŸèƒ½ ==========
        function showRenameModal(categoryName) {
            document.getElementById('oldCategoryName').value = categoryName;
            document.getElementById('oldCategoryDisplay').textContent = categoryName;
            document.getElementById('newCategoryName').value = categoryName;
            document.getElementById('renameModal').classList.remove('hidden');
            document.getElementById('renameModal').classList.add('flex');
            document.getElementById('newCategoryName').focus();
            document.getElementById('newCategoryName').select();
        }

        function hideRenameModal() {
            document.getElementById('renameModal').classList.add('hidden');
            document.getElementById('renameModal').classList.remove('flex');
        }

        async function renameCategory() {
            const oldName = document.getElementById('oldCategoryName').value;
            const newName = document.getElementById('newCategoryName').value.trim();
            
            if (!newName) {
                showToast('è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°', 'error');
                return;
            }
            
            if (oldName === newName) {
                hideRenameModal();
                return;
            }

            try {
                const response = await fetch(`/api/batch/${currentBatchId}/category/rename`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_name: oldName, new_name: newName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ›´æ–°é¢æ¿æ ‡é¢˜
                    const panel = document.querySelector(`.category-column[data-category="${oldName}"]`);
                    if (panel) {
                        panel.dataset.category = newName;
                        const titleEl = panel.querySelector('.category-title');
                        if (titleEl) titleEl.textContent = newName;
                        
                        // æ›´æ–°æ‰€æœ‰åé¦ˆé¡¹çš„ data-category
                        panel.querySelectorAll('.feedback-item').forEach(item => {
                            item.dataset.category = newName;
                        });
                        
                        // æ›´æ–° ondrop äº‹ä»¶
                        panel.ondrop = (e) => handleDrop(e, newName);
                        
                        // æ›´æ–°ç¼–è¾‘æŒ‰é’®çš„ onclick
                        const editBtn = panel.querySelector('button[title="é‡å‘½ååˆ†ç±»"]');
                        if (editBtn) {
                            editBtn.onclick = (e) => { e.stopPropagation(); showRenameModal(newName); };
                        }
                    }
                    
                    // æ›´æ–°ç»Ÿè®¡åŒºåŸŸ
                    const statEl = document.querySelector(`#categoryStats [data-category="${oldName}"]`);
                    if (statEl) {
                        statEl.dataset.category = newName;
                        const nameSpan = statEl.querySelector('span');
                        if (nameSpan) nameSpan.textContent = newName;
                        statEl.onclick = () => toggleCategory(newName);
                    }
                    
                    // æ›´æ–°ç»Ÿè®¡æ•°æ®
                    if (result.stats) {
                        updateStats(result.stats);
                    }
                    
                    hideRenameModal();
                    showToast(result.message, 'success');
                } else {
                    showToast(result.detail || 'é‡å‘½åå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('é‡å‘½åå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å›è½¦é”®ç¡®è®¤é‡å‘½å
        document.getElementById('newCategoryName')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                renameCategory();
            }
        });
    </script>
</body>
</html>
